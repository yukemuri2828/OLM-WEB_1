<!-- 省略: <head>やスタイルはそのままでOK（前回v1.2と同じ） -->
...
<body>
  <div class="wrap">
    <!-- 同意画面はそのまま -->

    <!-- ▼ 設定画面：文言を変更 -->
    <div class="card" id="screen-setup" hidden>
      <h1>参加者IDと設定</h1>
      <p><b>生年月日をIDにしてください（例：20011224）</b>。空欄なら自動IDになります。</p>
      <div class="row"><input id="pid" class="btn full" placeholder="例：20011224" /></div>
      <p class="muted">デバイス: <span id="ua"></span><br/> 画面: <span id="vw"></span> × <span id="vh"></span> px</p>
      <div class="row" style="margin-top:12px">
        <button class="btn primary full" id="btn-setup-go">準備OK</button>
      </div>
    </div>

    <!-- 説明画面はそのまま（セットサイズだけ表示） -->

    <div class="card" id="screen-task" hidden>
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div class="muted">参加者: <span id="label-pid" class="mono"></span>｜Trial <span id="label-trial"></span>/<span id="label-total"></span></div>
        <div class="muted">段階: <span id="label-phase">学習</span></div>
      </div>
      <div class="bar"><div id="bar"></div></div>
      <div class="stage" id="stage"><div class="grid"></div></div>
      <div class="tray" id="tray"></div>
      <div class="row" style="margin-top:10px; gap:10px;">
        <button class="btn full" id="btn-reset">やり直す</button>
        <button class="btn primary full" id="btn-confirm">回答を確定</button>
      </div>
      <!-- ▼ ヒント文をリクエストどおりに -->
      <p class="muted" id="hint">分からない場合は適当で構いません。最後まで問題をやり遂げてください。</p>
    </div>

    <!-- 完了画面はそのまま -->
    <div class="footer">OLM Web Template • v1.3（残像なし・はみ出し抑制強化）</div>
  </div>

  <script>
  const CONFIG = {
    STUDY_SECONDS: 8,
    SET_SIZES: [3,5,7],
    TRIALS_PER_SET: 2,
    COLOR_CONDITIONS: ['single','multi'],
    ALLOW_RADIUS_PX: 32,
    ENDPOINT_URL: "https://script.google.com/macros/s/AKfycbySOvpNa1UKRK44wo0ubT68_gnEhTW6VDaSZXkWRFPPwo8pZ3Xef6Oz8SZxVhGnWR8V3g/exec",
    SEND_LOGS: true,
    COLORS: [
      {name:'red',   hex:'#e63946', border:'#b91c1c'},
      {name:'blue',  hex:'#457b9d', border:'#1d4ed8'},
      {name:'green', hex:'#2a9d8f', border:'#065f46'},
      {name:'yellow',hex:'#e9c46a', border:'#b45309'}
    ],
    SINGLE_COLOR: {name:'blue', hex:'#1f77b4', border:'#1d4ed8'}
  };

  const S = { pid:null, trialIndex:0, trials:[], phase:"study", studyStart:0, recallStart:0, adjustments:0 };
  const $ = q=>document.querySelector(q);
  const stage=$('#stage'), tray=$('#tray'), bar=$('#bar');
  const labelPid=$('#label-pid'), labelTrial=$('#label-trial'), labelTotal=$('#label-total'), labelPhase=$('#label-phase');

  function show(id){ for(const el of document.querySelectorAll('.card')) el.hidden=true; $(id).hidden=false; }

  (function init(){
    $('#ua').textContent = navigator.userAgent;
    $('#vw').textContent = window.innerWidth;
    $('#vh').textContent = window.innerHeight;

    show('#screen-consent');
    $('#btn-consent-yes').onclick = ()=> show('#screen-setup');
    $('#btn-consent-no').onclick  = ()=>{ alert('終了します'); location.href='about:blank'; };

    $('#btn-setup-go').onclick = ()=>{
      const v = ($('#pid').value||'').trim();
      S.pid = v || ('p'+Math.random().toString(36).slice(2,9));
      labelPid.textContent = S.pid;
      $('#ins-n') && ($('#ins-n').textContent = CONFIG.SET_SIZES.join(' / '));
      buildTrials();
      show('#screen-instruction');
    };

    $('#btn-start')?.addEventListener('click', startExperiment);
    $('#btn-reset').onclick = ()=>{ if(S.phase==='recall'){ S.adjustments=0; toRecall(); } };
    $('#btn-confirm').onclick = confirmAnswer;
  })();

  function buildTrials(){
    const t=[];
    for(const cond of CONFIG.COLOR_CONDITIONS){
      for(const n of CONFIG.SET_SIZES){
        for(let r=0;r<CONFIG.TRIALS_PER_SET;r++){ t.push(makeTrial(n,cond)); }
      }
    }
    for(let i=t.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [t[i],t[j]]=[t[j],t[i]]; }
    S.trials=t;
  }

  // ★ はみ出し対策強化：padを大きく、最小72px／画面の10％
  function makeTrial(n, colorCondition){
    const W = stage.clientWidth || 360;
    const H = stage.clientHeight || W;
    const pad = Math.max(72, Math.floor(Math.min(W,H)*0.10));
    const targets=[];
    let attempts=0;
    while(targets.length<n && attempts<8000){
      attempts++;
      const x = pad + Math.random()*(W - pad*2);
      const y = pad + Math.random()*(H - pad*2);
      // ★ オブジェクト間隔も拡大（66px）
      const ok = targets.every(o => Math.hypot(o.x-x, o.y-y) > 66);
      if(ok){ targets.push({id:'O'+targets.length, x, y}); }
    }

    if(colorCondition==='single'){
      for(const o of targets) o.color={...CONFIG.SINGLE_COLOR};
    }else{
      for(let i=0;i<targets.length;i++) targets[i].color={...CONFIG.COLORS[i%CONFIG.COLORS.length]};
      for(let i=targets.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [targets[i].color,targets[j].color]=[targets[j].color,targets[i].color]; }
    }
    return { n, colorCondition, targets };
  }

  function startExperiment(){ S.trialIndex=0; nextTrial(); show('#screen-task'); }

  function nextTrial(){
    if(S.trialIndex>=S.trials.length){ show('#screen-finish'); $('#done-pid').textContent=S.pid; return; }
    const t=S.trials[S.trialIndex];
    labelTrial.textContent=S.trialIndex+1; labelTotal.textContent=S.trials.length;
    S.phase='study'; labelPhase.textContent='学習';
    tray.innerHTML=''; S.adjustments=0;
    renderStage(t.targets,true); bar.style.width='0%';
    const start=performance.now(); S.studyStart=start;
    const timer=setInterval(()=>{
      const dt=(performance.now()-start)/1000, r=Math.min(1, dt/CONFIG.STUDY_SECONDS);
      bar.style.width=(r*100).toFixed(1)+'%';
      if(dt>=CONFIG.STUDY_SECONDS){ clearInterval(timer); toRecall(); }
    },50);
  }

  // 学習時のみ表示、想起では完全非表示（残像ゼロ）
  function renderStage(targets, showDuringStudy){
    stage.querySelectorAll('.obj').forEach(n=>n.remove());
    if(!showDuringStudy) return;
    for(const o of targets){
      const d=document.createElement('div');
      d.className='obj'; d.textContent=o.id.replace('O','');
      d.style.left=(o.x-22)+'px'; d.style.top=(o.y-22)+'px';
      d.style.background=o.color.hex; d.style.borderColor=o.color.border;
      stage.appendChild(d);
    }
  }

  function toRecall(){
    S.phase='recall'; labelPhase.textContent='想起';
    bar.style.width='0%';
    renderStage(S.trials[S.trialIndex].targets,false); // 非表示
    tray.innerHTML='';
    for(const o of S.trials[S.trialIndex].targets){
      const drag=document.createElement('div');
      drag.className='obj ghosting'; drag.textContent=o.id.replace('O',''); drag.dataset.id=o.id;
      drag.style.left=(8+Math.random()*40)+'px';
      drag.style.top=(stage.clientHeight-52-Math.random()*40)+'px';
      drag.style.background=o.color.hex; drag.style.borderColor=o.color.border;
      attachDrag(drag); stage.appendChild(drag);
    }
    S.recallStart=performance.now();
  }

  function attachDrag(el){
    let ox=0,oy=0,dragging=false;
    const start=e=>{ dragging=true; S.adjustments++; const t=(e.touches?e.touches[0]:e); const r=el.getBoundingClientRect(); ox=t.clientX-r.left; oy=t.clientY-r.top; };
    const move=e=>{
      if(!dragging) return;
      const t=(e.touches?e.touches[0]:e), st=stage.getBoundingClientRect();
      let x=t.clientX-st.left-ox+22, y=t.clientY-st.top-oy+22;
      x=Math.max(22, Math.min(stage.clientWidth-22, x));
      y=Math.max(22, Math.min(stage.clientHeight-22, y));
      el.style.left=(x-22)+'px'; el.style.top=(y-22)+'px';
    };
    const end=()=>{ dragging=false; };
    el.addEventListener('touchstart',start,{passive:false});
    el.addEventListener('touchmove',move,{passive:false});
    el.addEventListener('touchend',end,{passive:false});
    el.addEventListener('mousedown',start);
    window.addEventListener('mousemove',move);
    window.addEventListener('mouseup',end);
  }

  function confirmAnswer(){
    if(S.phase!=='recall') return;
    const t=S.trials[S.trialIndex];
    const placed={}; stage.querySelectorAll('.obj.ghosting').forEach(el=>{
      const id=el.dataset.id; const x=parseFloat(el.style.left)+22; const y=parseFloat(el.style.top)+22; placed[id]={x,y};
    });
    const rt_ms=Math.round(performance.now()-S.recallStart);
    const rows=[]; const W=stage.clientWidth, H=stage.clientHeight;
    for(const o of t.targets){
      const r=placed[o.id]; const dx=(r?.x??0)-o.x, dy=(r?.y??0)-o.y;
      const dist=Math.hypot(dx,dy); const correct=dist<=CONFIG.ALLOW_RADIUS_PX;
      rows.push({
        pid:S.pid, trial_index:S.trialIndex+1, n:t.n,
        trial_color_condition:t.colorCondition, obj_id:o.id, obj_color:o.color.name,
        target_x_px:Math.round(o.x), target_y_px:Math.round(o.y),
        resp_x_px:Math.round(r?.x ?? -1), resp_y_px:Math.round(r?.y ?? -1),
        target_x_norm:+(o.x/W).toFixed(6), target_y_norm:+(o.y/H).toFixed(6),
        resp_x_norm:+((r?.x??-1)/W).toFixed(6), resp_y_norm:+((r?.y??-1)/H).toFixed(6),
        err_px:+dist.toFixed(2), correct_radius_px:CONFIG.ALLOW_RADIUS_PX,
        correct:+correct, rt_ms:rt_ms, adjust_count:S.adjustments,
        ua:navigator.userAgent, vw:window.innerWidth, vh:window.innerHeight, ts:new Date().toISOString()
      });
    }
    if(CONFIG.SEND_LOGS && CONFIG.ENDPOINT_URL.includes('script.google.com')){
      fetch(CONFIG.ENDPOINT_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({kind:'olm',version:'1.3',rows})}).catch(()=>{});
    }
    S.trialIndex++; nextTrial();
  }
  </script>
</body>
</html>
